name: Weekly AI Summary

on:
  schedule:
    - cron: '0 8 * * 1'  # Every Monday at 08:00 UTC
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests openai

      - name: Fetch last week's repository activity
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python <<EOF
import requests
from datetime import datetime, timedelta, timezone
import os

github_repo = os.environ['GITHUB_REPOSITORY']

now = datetime.now(timezone.utc)
current_monday = (now - timedelta(days=now.weekday())).replace(
    hour=0, minute=0, second=0, microsecond=0
)
start = current_monday - timedelta(days=7)
end = current_monday

headers = {
    "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
    "Accept": "application/vnd.github+json"
}

def get_paginated(url, params):
    results = []
    while url:
        response = requests.get(url, headers=headers, params=params, timeout=30)
        params = {}
        if response.status_code != 200:
            raise Exception(f"GitHub API error ({url}): {response.status_code} - {response.text}")
        data = response.json()
        if isinstance(data, list):
            results.extend(data)
        else:
            results.append(data)
        link = response.headers.get("Link", "")
        next_url = None
        for part in link.split(","):
            if 'rel="next"' in part:
                next_url = part[part.find("<")+1:part.find(">")]
                break
        url = next_url
    return results

time_params = {
    "since": start.isoformat().replace("+00:00", "Z"),
    "until": end.isoformat().replace("+00:00", "Z"),
    "per_page": 100
}

commits = get_paginated(f"https://api.github.com/repos/{github_repo}/commits", time_params.copy())
pulls = get_paginated(
    f"https://api.github.com/repos/{github_repo}/pulls",
    {"state": "all", "sort": "updated", "direction": "desc", "per_page": 100}
)
issues = get_paginated(
    f"https://api.github.com/repos/{github_repo}/issues",
    {"state": "all", "sort": "updated", "direction": "desc", "per_page": 100}
)

def in_window(iso_ts):
    ts = datetime.fromisoformat(iso_ts.replace("Z", "+00:00"))
    return start <= ts < end

commit_lines = [
    f"- {c['commit']['author']['date']}: {c['commit']['message'].splitlines()[0]}"
    for c in commits
]

pull_lines = []
for pr in pulls:
    updated = pr.get("updated_at")
    if updated and in_window(updated):
        pull_lines.append(
            f"- PR #{pr['number']} [{pr['state']}] updated {updated}: {pr['title']}"
        )

issue_lines = []
for issue in issues:
    if "pull_request" in issue:
        continue
    updated = issue.get("updated_at")
    if updated and in_window(updated):
        issue_lines.append(
            f"- Issue #{issue['number']} [{issue['state']}] updated {updated}: {issue['title']}"
        )

with open("activity.txt", "w", encoding="utf-8") as f:
    f.write(
        "Week window (UTC): "
        f"{start.isoformat()} to {end.isoformat()}\n\n"
        f"Commits ({len(commit_lines)}):\n"
        + ("\n".join(commit_lines) if commit_lines else "- None")
        + f"\n\nPull Requests ({len(pull_lines)}):\n"
        + ("\n".join(pull_lines) if pull_lines else "- None")
        + f"\n\nIssues ({len(issue_lines)}):\n"
        + ("\n".join(issue_lines) if issue_lines else "- None")
    )
EOF

      - name: Summarize with OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python <<EOF
import os
from openai import OpenAI

with open("activity.txt", "r", encoding="utf-8") as f:
    activity_text = f.read()

prompt = (
    "You are generating a weekly engineering summary for leadership. "
    "Summarize the previous week of GitHub activity. Include: "
    "(1) major completed work, "
    "(2) in-progress or changing areas, "
    "(3) notable risks/blockers/security-relevant items. "
    "Keep it under 140 words, clear and factual.\n\n"
    f"Repository: {os.environ['GITHUB_REPOSITORY']}\n\n"
    f"{activity_text}"
)

client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])
response = client.responses.create(
    model="gpt-4o-mini",
    input=prompt,
    temperature=0.3
)
summary = response.output_text.strip()

print("--- AI Weekly Summary ---")
print(summary)
with open("weekly_summary.txt", "w", encoding="utf-8") as f:
    f.write(summary)
EOF

      - name: Upload summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-summary
          path: weekly_summary.txt
